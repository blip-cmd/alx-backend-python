{% extends 'messaging/base.html' %} {% block title %}Messages - Messaging
System{% endblock %} {% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-inbox"></i> Your Messages</h2>
      <a href="{% url 'messaging:send_message' %}" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i> Send New Message
      </a>
    </div>

    {% if messages %}
    <div class="row">
      {% for message in messages %}
      <div class="col-lg-6 col-md-6 mb-4">
        <div class="card message-card h-100">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <div>
              {% if message.sender == user %}
              <i class="fas fa-arrow-right text-success"></i>
              <strong>To:</strong> {{ message.receiver.username }} {% else %}
              <i class="fas fa-arrow-left text-primary"></i>
              <strong>From:</strong> {{ message.sender.username }} {% endif %}
            </div>
            <div>
              {% if message.edited %}
              <span class="badge bg-warning edited-badge">
                <i class="fas fa-edit"></i> Edited
              </span>
              {% endif %}
              <small class="text-muted"
                >{{ message.timestamp|date:"M d, Y H:i" }}</small
              >
            </div>
          </div>

          <div class="card-body">
            <p class="message-content">
              {% if message.content|length > 100 %} {{
              message.content|slice:":100" }}... {% else %} {{ message.content
              }} {% endif %}
            </p>

            {% if message.edited %}
            <small class="text-muted">
              <i class="fas fa-history"></i>
              {{ message.edit_history.count }} edit{{
              message.edit_history.count|pluralize }} available
            </small>
            {% endif %}
          </div>

          <div class="card-footer">
            <a
              href="{% url 'messaging:message_detail' message.id %}"
              class="btn btn-sm btn-outline-primary"
            >
              <i class="fas fa-eye"></i> View Details
            </a>

            {% if message.sender == user %}
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="editMessage({{ message.id }})"
            >
              <i class="fas fa-edit"></i> Edit
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="fas fa-inbox fa-5x text-muted mb-3"></i>
      <h4 class="text-muted">No messages yet</h4>
      <p class="text-muted">Start by sending your first message!</p>
      <a href="{% url 'messaging:send_message' %}" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i> Send Your First Message
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Quick Edit Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Message</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editMessageForm">
          <div class="mb-3">
            <label for="messageContent" class="form-label"
              >Message Content</label
            >
            <textarea
              class="form-control"
              id="messageContent"
              rows="4"
              required
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="saveMessageBtn">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentMessageId = null;

  function editMessage(messageId) {
    currentMessageId = messageId;

    // Get current content via API or from the page
    fetch(`/messaging/api/message/${messageId}/history/`)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("messageContent").value = data.current_content;
        const modal = new bootstrap.Modal(
          document.getElementById("editMessageModal")
        );
        modal.show();
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error loading message content");
      });
  }

  document
    .getElementById("saveMessageBtn")
    .addEventListener("click", function () {
      if (!currentMessageId) return;

      const content = document.getElementById("messageContent").value.trim();
      if (!content) {
        alert("Message content cannot be empty");
        return;
      }

      fetch(`/messaging/message/${currentMessageId}/edit/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          content: content,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editMessageModal")
            );
            modal.hide();
            location.reload(); // Reload to show changes
          } else {
            alert(data.error || "Error updating message");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Error updating message");
        });
    });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
